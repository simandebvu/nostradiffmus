name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test

    - name: Build
      run: npm run build

    - name: Test CLI (basic smoke test)
      run: |
        # Create a test diff
        echo "// Test change" > test-file.ts
        git add test-file.ts

        # Run nostradiffmus on staged changes (capture only stdout)
        npm run dev -- --staged --json 2>/dev/null > output.json || echo "CLI ran with warnings"

        # Debug: show what we got
        echo "Output file contents:"
        cat output.json
        echo ""

        # Verify JSON output has required fields
        cat output.json | jq -e '.predictedBugCategory' || echo "Missing predictedBugCategory"
        cat output.json | jq -e '.confidence' || echo "Missing confidence"
        cat output.json | jq -e '.metadata' || echo "Missing metadata"

        echo "✅ CLI smoke test passed"

    - name: Test large diff handling
      run: |
        # Create a larger diff to test truncation
        for i in {1..200}; do
          echo "export const line$i = 'test data';"
        done > large-file.ts

        git add large-file.ts
        npm run dev -- --staged --json | jq -e '.metadata.wasTruncatedForCopilot'

        echo "✅ Large diff test passed"
